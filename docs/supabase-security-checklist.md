
# Контрольный список безопасности Supabase

Этот контрольный список поможет обеспечить правильную настройку безопасности для вашего проекта Supabase, используемого в приложении учёта волонтёрской активности.

## Аутентификация

### Базовые настройки
- [ ] Включена строгая политика паролей (`enable_strong_password_policy = true`)
- [ ] Установлена минимальная длина пароля не менее 10 символов (`min_password_length = 10`)
- [ ] Включено подтверждение по электронной почте (`require_email_confirmation = true`)
- [ ] Включена двойная проверка подтверждения изменений (`double_confirm_changes = true`)
- [ ] Включена защита от перебора паролей (настройка через интерфейс Supabase)
- [ ] Настроено регулярное истечение срока действия JWT (например, `jwt_expiry = 3600`)
- [ ] Включена ротация токенов обновления (`enable_refresh_token_rotation = true`)

### Дополнительные меры
- [ ] Настройте многофакторную аутентификацию (MFA) для чувствительных операций
- [ ] Ограничьте количество запросов авторизации в единицу времени
- [ ] Настройте уведомления о подозрительных входах в систему
- [ ] Регулярно очищайте неиспользуемые и устаревшие сессии

## Row Level Security (RLS)

### Общие принципы
- [ ] RLS включен для **всех** таблиц
- [ ] Политики основаны на принципе "запрещено всё, что не разрешено явно"
- [ ] Таблицы с чувствительными данными имеют строгие политики чтения/записи
- [ ] Политики используют проверку подлинности пользователя через `auth.uid()`

### Проверка политик безопасности
Для каждой таблицы проверьте:

#### Таблица volunteers
```sql
-- Политики чтения
CREATE POLICY "Волонтёры могут видеть только свой профиль" 
  ON "public"."volunteers"
  FOR SELECT USING (auth.uid() = id);

-- Политики редактирования
CREATE POLICY "Волонтёры могут редактировать только свой профиль" 
  ON "public"."volunteers"
  FOR UPDATE USING (auth.uid() = id);
```

#### Таблица events
```sql
-- Политики чтения
CREATE POLICY "События видны всем аутентифицированным пользователям" 
  ON "public"."events"
  FOR SELECT USING (auth.role() = 'authenticated');

-- Политики редактирования
CREATE POLICY "Только организаторы могут редактировать свои события" 
  ON "public"."events"
  FOR UPDATE USING (auth.uid() = organizerid);
```

#### Таблица participations
```sql
-- Политики чтения
CREATE POLICY "Участия видны их владельцам и организаторам мероприятий" 
  ON "public"."participations"
  FOR SELECT USING (
    auth.uid() = volunteerid OR 
    EXISTS (SELECT 1 FROM events WHERE id = eventid AND organizerid = auth.uid())
  );

-- Политики создания
CREATE POLICY "Волонтёры могут создавать только свои участия" 
  ON "public"."participations"
  FOR INSERT WITH CHECK (auth.uid() = volunteerid);
```

## Edge Functions и API

### Безопасность функций
- [ ] Включена проверка JWT для всех функций (`verify_jwt = true`)
- [ ] Используются роли с минимальными необходимыми правами
- [ ] Включена проверка входных данных и их санитизация
- [ ] Настроены ограничения на вызов функций (rate limiting)

### Безопасность API
- [ ] API-ключи разделены по уровням доступа (ограниченный доступ для фронтенда)
- [ ] Включена защита от CSRF для всех POST-запросов
- [ ] Настроены CORS-политики для всех публичных API
- [ ] Используется HTTPS для всех API-запросов

## Хранение данных

### Шифрование и защита
- [ ] Чувствительные данные хранятся в зашифрованном виде
- [ ] Установлены правильные настройки резервного копирования
- [ ] Настроен безопасный доступ к хранилищу файлов через RLS
- [ ] Проверены разрешения на чтение/запись для публичных хранилищ

### Storage
- [ ] Политики безопасности настроены для всех бакетов
- [ ] Установлены ограничения на размер загружаемых файлов
- [ ] Настроены политики для безопасного доступа к файлам волонтёров

## Регулярные проверки

- [ ] Проверка логов на подозрительную активность
- [ ] Регулярное обновление Supabase до последней версии
- [ ] Аудит политик безопасности при изменении схемы данных
- [ ] Тестирование безопасности API и функций после обновлений

## Дополнительно

### Мониторинг и логирование
- [ ] Настроено логирование всех важных действий пользователей
- [ ] Настроено оповещение о подозрительной активности
- [ ] Регулярно проверяются доступы и разрешения пользователей
- [ ] Настроено отслеживание ошибок в приложении

### Резервное копирование
- [ ] Настроены регулярные резервные копии базы данных
- [ ] Протестировано восстановление из резервной копии
- [ ] Резервные копии хранятся в безопасном месте

## Ресурсы
- [Документация по безопасности Supabase](https://supabase.com/docs/guides/auth)
- [Row Level Security в PostgreSQL](https://supabase.com/docs/guides/auth/row-level-security)
- [Настройка политик безопасности](https://supabase.com/docs/guides/auth/managing-user-data)
- [Лучшие практики аутентификации](https://supabase.com/docs/guides/auth/auth-helpers)
